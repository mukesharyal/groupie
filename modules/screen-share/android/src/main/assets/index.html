<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        /* Existing styles... */
        body { background-color: #0f0f0f; color: white; font-family: -apple-system, system-ui, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .phone-mockup { position: relative; width: 90vw; max-width: 360px; aspect-ratio: 9 / 19.5; background-color: #000; border-radius: 55px; border: 10px solid #2a2a2a; outline: 4px solid #1a1a1a; box-shadow: 0 40px 100px rgba(0,0,0,0.9), inset 0 0 20px rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; background-color: #000; }
        .status-container { margin-top: 40px; text-align: center; }
        .status-pill { display: inline-flex; align-items: center; gap: 10px; background: #1a1a1a; padding: 12px 28px; border-radius: 40px; font-size: 12px; font-weight: 700; letter-spacing: 1px; color: #666; border: 1px solid #333; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .status-pill.live { color: #2ecc71; border-color: #2ecc71; background: rgba(46, 204, 113, 0.1); box-shadow: 0 0 20px rgba(46, 204, 113, 0.15); }
        .dot { width: 8px; height: 8px; background: #444; border-radius: 50%; }
        .live .dot { background: #2ecc71; box-shadow: 0 0 10px #2ecc71; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.4; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="phone-mockup">
        <video id="remoteVideo" autoplay playsinline muted></video>
    </div>

    <div class="status-container">
        <div id="status-pill" class="status-pill">
            <div class="dot"></div>
            <span id="status-text">DISCONNECTED</span>
        </div>
    </div>

    <script type="module">
        import { webSocketAddress } from './address.js';

        const video = document.getElementById('remoteVideo');
        const statusText = document.getElementById('status-text');
        const statusPill = document.getElementById('status-pill');
        
        let pc = new RTCPeerConnection({
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });

        // Store reference to the data channel
        let dataChannel = null;

        const socket = new WebSocket(webSocketAddress);

        socket.onopen = () => statusText.innerText = "LINK ESTABLISHED";

        socket.onmessage = async (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription(data));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.send(JSON.stringify({ type: 'answer', sdp: answer.sdp }));
            } else if (data.type === 'candidate') {
                try { await pc.addIceCandidate(new RTCIceCandidate(data)); } catch (e) {}
            }
        };

        // --- DATA CHANNEL LISTENER ---
        pc.ondatachannel = (event) => {
            dataChannel = event.channel;
            
            dataChannel.onopen = () => {
                console.log("Data Channel is OPEN");
                // Example: Send a message back to Android
                dataChannel.send("Hello from the Browser!");
            };

            dataChannel.onmessage = (event) => {
                console.log("Message from Android:", event.data);
                // You can trigger UI changes here based on what Android sends
            };

            dataChannel.onclose = () => {
                console.log("Data Channel is CLOSED");
            };
        };

        socket.onclose = () => {
            if (pc.connectionState !== 'connected') {
                statusText.innerText = "SERVER CLOSED";
            }
        };

        pc.ontrack = (event) => {
            if (event.streams && event.streams[0]) {
                video.srcObject = event.streams[0];
            }
        };

        pc.onicecandidate = (event) => {
            if (event.candidate && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'candidate',
                    candidate: event.candidate.candidate,
                    sdpMid: event.candidate.sdpMid,
                    sdpMLineIndex: event.candidate.sdpMLineIndex
                }));
            }
        };

        pc.onconnectionstatechange = () => {
            if (pc.connectionState === 'connected') {
                statusText.innerText = "LIVE STREAMING";
                statusPill.classList.add('live');
            } else if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
                statusText.innerText = "SESSION ENDED";
                statusPill.classList.remove('live');
            }
        };
    </script>
</body>
</html>